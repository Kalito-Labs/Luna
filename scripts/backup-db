#!/bin/bash

# Find the Luna project root by looking for backend/db/kalito.db
if [ -f "./backend/db/kalito.db" ]; then
    # Already in project root
    PROJECT_ROOT="."
elif [ -f "./kalito.db" ]; then
    # In backend/db directory
    PROJECT_ROOT="../.."
elif [ -f "../backend/db/kalito.db" ]; then
    # In backend or another top-level directory
    PROJECT_ROOT=".."
elif [ -f "$HOME/kalito-labs/Luna/backend/db/kalito.db" ]; then
    # Fallback to absolute path
    PROJECT_ROOT="$HOME/kalito-labs/Luna"
else
    echo "Error: Could not find Luna project database"
    echo "Please run this from the Luna project directory or its subdirectories"
    exit 1
fi

DB="${PROJECT_ROOT}/backend/db/kalito.db"
BACKUP_DIR="${PROJECT_ROOT}/backups"
TIMESTAMP="$(date +%F_%H%M%S)"
BACKUP_FILE="${BACKUP_DIR}/kalito.db.${TIMESTAMP}.bak"

mkdir -p "$BACKUP_DIR"

if [ ! -f "$DB" ]; then
    echo "Error: Database not found at $DB"
    exit 1
fi

sqlite3 "$DB" ".backup '$BACKUP_FILE'"
echo "âœ… Backup created at $BACKUP_FILE"
